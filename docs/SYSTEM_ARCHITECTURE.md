# System Architecture - Crypto Payment Integration

## ??? High-Level Architecture

```
???????????????????????????????????????????????????????????????????
?                     EXPO REACT NATIVE APP                        ?
?                     (Mobile Application)                         ?
???????????????????????????????????????????????????????????????????
             ?                                 ?
             ? REST API (HTTPS)                ? Deep Links
             ? JWT Authentication              ?
             ?                                 ?
             ?                                 ?
??????????????????????????????????  ???????????????????????????????
?    .NET 10 API Backend         ?  ?   User's Crypto Wallet      ?
?    (ASP.NET Core)              ?  ?   (Trust Wallet, MetaMask)  ?
?                                ?  ?                             ?
?  ????????????????????????????  ?  ?  - Scan QR Code            ?
?  ?  CryptoPaymentController ?  ?  ?  - Send USDT               ?
?  ?  - Create Payment        ?  ?  ?  - Get Transaction Hash    ?
?  ?  - Verify Payment        ?  ?  ???????????????????????????????
?  ?  - Check Status          ?  ?
?  ?  - Get History           ?  ?
?  ????????????????????????????  ?
?             ?                  ?
?  ????????????????????????????  ?
?  ?  CryptoPaymentService    ?  ?
?  ?  - Payment Logic         ?  ?
?  ?  - Amount Calculation    ?  ?
?  ?  - Status Management     ?  ?
?  ????????????????????????????  ?
?             ?                  ?
?  ????????????????????????????  ?
?  ? BlockchainVerificationSvc?  ?
?  ?  - TRC-20 (Tron)         ?  ?
?  ?  - ERC-20 (Ethereum)     ?  ?
?  ?  - BEP-20 (BSC)          ????????????
?  ????????????????????????????  ?        ?
?             ?                  ?        ?
?  ????????????????????????????  ?        ?
?  ?    PostgreSQL Database   ?  ?        ?
?  ?  - Payment Requests      ?  ?        ?
?  ?  - Transactions          ?  ?        ?
?  ?  - Exchange Rates        ?  ?        ?
?  ????????????????????????????  ?        ?
?                                ?        ?
?  ????????????????????????????  ?        ?
?  ?  Hangfire Background Jobs?  ?        ?
?  ?  - Update Exchange Rates ?  ?        ?
?  ?  - Monitor Payments      ?  ?        ?
?  ?  - Expire Old Payments   ?  ?        ?
?  ????????????????????????????  ?        ?
???????????????????????????????????        ?
             ?                             ?
             ? RPC Calls                   ?
             ? (Blockchain Queries)        ?
             ?                             ?
????????????????????????????????????????????
?         BLOCKCHAIN NETWORKS             ??
?                                         ??
?  ??????????????????????????????????    ??
?  ?  Tron Network (TRC-20)         ???????
?  ?  - TronGrid API                ?     ?
?  ?  - 6 decimals                  ?     ?
?  ?  - 19 confirmations            ?     ?
?  ??????????????????????????????????     ?
?                                         ?
?  ??????????????????????????????????    ?
?  ?  Ethereum Network (ERC-20)     ??????
?  ?  - Infura RPC                  ?
?  ?  - 6 decimals                  ?
?  ?  - 12 confirmations            ?
?  ??????????????????????????????????
?                                         ?
?  ??????????????????????????????????    ?
?  ?  BSC Network (BEP-20)          ??????
?  ?  - BSC RPC                     ?
?  ?  - 18 decimals ??              ?
?  ?  - 15 confirmations            ?
?  ??????????????????????????????????
???????????????????????????????????????????
```

---

## ?? Frontend Component Architecture

```
????????????????????????????????????????????????????????????????
?                     App Navigation                            ?
?                  (React Navigation)                           ?
????????????????????????????????????????????????????????????????
             ?
             ???? Home Screen
             ?
             ???? Premium Subscription Screen
             ?    (Select Plan)
             ?
             ?
     ?????????????????????????????????????????
     ?   CryptoPaymentScreen                 ?
     ?                                       ?
     ?   Components:                         ?
     ?   ?? NetworkSelector                 ?
     ?   ?  ?? [Tron][Ethereum][BSC]        ?
     ?   ?                                  ?
     ?   ?? PaymentDetails                  ?
     ?   ?  ?? Amount Display               ?
     ?   ?  ?? Timer Countdown              ?
     ?   ?  ?? Exchange Rate                ?
     ?   ?                                  ?
     ?   ?? PaymentQRCode                   ?
     ?   ?  ?? QR Code Generator            ?
     ?   ?                                  ?
     ?   ?? WalletAddress                   ?
     ?   ?  ?? Address Display              ?
     ?   ?  ?? Copy Button                  ?
     ?   ?                                  ?
     ?   ?? TransactionHashInput            ?
     ?   ?  ?? Text Input                   ?
     ?   ?  ?? Submit Button                ?
     ?   ?                                  ?
     ?   ?? PaymentStatus                   ?
     ?   ?  ?? Status Badge                 ?
     ?   ?  ?? ConfirmationProgress         ?
     ?   ?                                  ?
     ?   ?? Instructions                    ?
     ?      ?? Help Text                    ?
     ?????????????????????????????????????????
                     ?
                     ? Uses Hooks
                     ?
     ?????????????????????????????????????????
     ?   useCryptoPayment Hook               ?
     ?   ?? createPayment()                  ?
     ?   ?? verifyPayment()                  ?
     ?   ?? checkStatus()                    ?
     ?   ?? startPolling()                   ?
     ?   ?? stopPolling()                    ?
     ?????????????????????????????????????????
                     ?
                     ? Calls API
                     ?
     ?????????????????????????????????????????
     ?   CryptoPaymentAPI Service            ?
     ?   (Axios HTTP Client)                 ?
     ?   ?? POST /create                     ?
     ?   ?? POST /{id}/verify                ?
     ?   ?? GET /{id}                        ?
     ?   ?? POST /{id}/check-status          ?
     ?   ?? GET /history                     ?
     ?????????????????????????????????????????
```

---

## ?? Payment State Flow

```
                    ???????????????
                    ?   IDLE      ?
                    ???????????????
                           ?
                   User selects premium
                           ?
                           ?
                    ???????????????
                    ?  CREATING   ???????? POST /create
                    ???????????????
                           ?
                    Payment created
                           ?
                           ?
                    ???????????????
                    ?   PENDING   ???????? Show QR code
                    ???????????????        User sends crypto
                           ?
                  User submits TX hash
                           ?
                           ?
                    ???????????????
                    ? VERIFYING   ???????? POST /{id}/verify
                    ???????????????
                           ?
            ???????????????????????????????
            ?                             ?
       TX found                     TX not found
            ?                             ?
            ?                             ?
     ???????????????              ???????????????
     ? CONFIRMING  ?              ?   FAILED    ?
     ?  (polling)  ?              ???????????????
     ???????????????
            ?
    Polling every 5s
    (GET /{id} or POST /{id}/check-status)
            ?
            ? Confirmations: 0/19 ?????????????????
            ? Confirmations: 5/19 ?????????????????
            ? Confirmations: 12/19 ????????????????
            ? Confirmations: 19/19 ????????????????
            ?
            ?
     ???????????????
     ?  CONFIRMED  ?
     ???????????????
            ?
    Backend processes payment
            ?
            ?
     ???????????????
     ?  COMPLETED  ???????? Premium activated ?
     ???????????????
```

---

## ?? Authentication Flow

```
??????????????????????????????????????????????????????????????
?                    User Login/Register                      ?
??????????????????????????????????????????????????????????????
                      ?
                      ?
         ??????????????????????????????
         ?  POST /api/auth/login      ?
         ?  or                        ?
         ?  POST /api/auth/register   ?
         ??????????????????????????????
                       ?
                       ?
         ??????????????????????????????
         ?  Receive JWT Token         ?
         ?  {                         ?
         ?    token: "eyJhbGc...",    ?
         ?    userId: "uuid",         ?
         ?    name: "User Name"       ?
         ?  }                         ?
         ??????????????????????????????
                       ?
                       ?
         ??????????????????????????????
         ?  Store Token Securely      ?
         ?  (SecureStore / Keychain)  ?
         ??????????????????????????????
                       ?
                       ?
         ??????????????????????????????
         ?  All Crypto Payment API    ?
         ?  Calls Include:            ?
         ?  Authorization: Bearer {JWT}?
         ??????????????????????????????
```

---

## ?? Network Decimal Handling

```
????????????????????????????????????????????????????????????????
?                    ON-CHAIN AMOUNT                            ?
?                  (How it's stored on blockchain)              ?
????????????????????????????????????????????????????????????????
                     ?
         ?????????????????????????
         ?                       ?
         ?                       ?
???????????????????    ???????????????????????
?  Tron (TRC-20)  ?    ?  BSC (BEP-20)       ?
?  10,000,000     ?    ?  10,000,000,000...  ?
?  (6 decimals)   ?    ?  (18 decimals)      ?
???????????????????    ???????????????????????
         ?                        ?
         ? ÷ 10^6                 ? ÷ 10^18
         ?                        ?
         ?                        ?
???????????????????    ???????????????????????
?  Display: 10.00 ?    ?  Display: 10.00     ?
?  USDT           ?    ?  USDT               ?
???????????????????    ???????????????????????

?? CRITICAL: BSC uses 18 decimals!
Always use: amount = wei / Math.pow(10, decimals)
where decimals = network === 'binance-smart-chain' ? 18 : 6
```

---

## ?? Database Schema (Reference)

```
????????????????????????????????????????????
?      crypto_payment_requests             ?
????????????????????????????????????????????
? id (PK)                    UUID          ?
? user_id (FK)               UUID          ?
? bird_id (FK, nullable)     UUID          ?
? amount_usd                 DECIMAL       ?
? amount_crypto              DECIMAL       ?
? currency                   VARCHAR(10)   ?
? network                    VARCHAR(50)   ?
? exchange_rate              DECIMAL       ?
? wallet_address             VARCHAR(255)  ?
? user_wallet_address        VARCHAR(255)  ?
? transaction_hash           VARCHAR(255)  ?
? confirmations              INTEGER       ?
? required_confirmations     INTEGER       ?
? status                     VARCHAR(20)   ?
? purpose                    VARCHAR(50)   ?
? plan                       VARCHAR(20)   ?
? expires_at                 TIMESTAMP     ?
? confirmed_at               TIMESTAMP     ?
? completed_at               TIMESTAMP     ?
? created_at                 TIMESTAMP     ?
? updated_at                 TIMESTAMP     ?
????????????????????????????????????????????
         ?
         ? 1:N
         ?
????????????????????????????????????????????
?      crypto_transactions                 ?
????????????????????????????????????????????
? id (PK)                    UUID          ?
? payment_request_id (FK)    UUID          ?
? transaction_hash           VARCHAR(255)  ?
? from_address               VARCHAR(255)  ?
? to_address                 VARCHAR(255)  ?
? amount                     DECIMAL       ?
? currency                   VARCHAR(10)   ?
? network                    VARCHAR(50)   ?
? confirmations              INTEGER       ?
? block_number               BIGINT        ?
? block_hash                 VARCHAR(255)  ?
? fee                        DECIMAL       ?
? status                     VARCHAR(20)   ?
? created_at                 TIMESTAMP     ?
????????????????????????????????????????????
```

---

## ?? Timing Diagram

```
Time    User Action          Frontend              Backend               Blockchain
??????????????????????????????????????????????????????????????????????????????
0s      Select premium       
                             
1s                          POST /create
                                                    Create payment
                                                    Get exchange rate
                                                    Calculate amount
                            ?? Payment details
                            
2s                          Show QR code
                            Display address
                            Start timer (30min)
                            
10s     Open wallet app
        Scan QR code
        
15s     Send USDT                                                         ? TX broadcast
        
20s     Copy TX hash
        
25s     Paste TX hash
        Click Submit
                            POST /verify
                                                    Query blockchain     ? Verify TX
                                                    Validate amount
                                                    Validate address
                                                    Status: confirming
                            ?? Status: confirming
                            
26s                         Start polling (5s)
        
30s                         GET /check-status
                                                    Query blockchain     ? Get confirmations
                            ?? 3/19 confirmations
                            
35s                         GET /check-status
                                                    Query blockchain     ? Get confirmations
                            ?? 8/19 confirmations
                            
40s                         GET /check-status
                                                    Query blockchain     ? Get confirmations
                            ?? 14/19 confirmations
                            
45s                         GET /check-status
                                                    Query blockchain     ? Get confirmations
                                                    19/19 ?
                                                    Status: confirmed
                                                    Activate premium
                                                    Status: completed
                            ?? Status: completed
                            
46s                         Stop polling
                            Show success ?
        
        Notification
        "Premium activated!"
```

---

## ?? UI/UX Flow

```
???????????????????????????????????????????????????????????????
?                      Main App Screen                         ?
?  ????????????????????????????????????????????????????????   ?
?  ?  ????????????  ????????????  ????????????          ?   ?
?  ?  ?  Bird 1  ?  ?  Bird 2  ?  ?  Bird 3  ?  ...     ?   ?
?  ?  ????????????  ????????????  ????????????          ?   ?
?  ?                                                      ?   ?
?  ?  [Go Premium] ? User clicks                         ?   ?
?  ????????????????????????????????????????????????????????   ?
???????????????????????????????????????????????????????????????
                           ?
                           ?
???????????????????????????????????????????????????????????????
?                  Plan Selection Screen                       ?
?  ????????????????????????????????????????????????????????   ?
?  ?  Monthly    - $9.99/month   [Select]                ?   ?
?  ?  Yearly     - $99.99/year   [Select] ? 17% off!     ?   ?
?  ?  Lifetime   - $299.99       [Select]                ?   ?
?  ?                                                      ?   ?
?  ?  Payment Methods:                                   ?   ?
?  ?  ? Credit Card                                      ?   ?
?  ?  ? Cryptocurrency ? Selected                        ?   ?
?  ?                                                      ?   ?
?  ?  [Continue]                                         ?   ?
?  ????????????????????????????????????????????????????????   ?
???????????????????????????????????????????????????????????????
                           ?
                           ?
???????????????????????????????????????????????????????????????
?                   Crypto Payment Screen                      ?
?  ????????????????????????????????????????????????????????   ?
?  ?  Select Network:                                     ?   ?
?  ?  [Tron (Low Fee)] [Ethereum (High Fee)] [BSC (Mid)] ?   ?
?  ?         ? Selected                                   ?   ?
?  ?                                                      ?   ?
?  ?  Amount to Pay: 10.023456 USDT                      ?   ?
?  ?  USD Value: $9.99                                   ?   ?
?  ?  Time Remaining: ?? 29:45                          ?   ?
?  ?                                                      ?   ?
?  ?  ??????????????????????????????????????????????    ?   ?
?  ?  ?                                            ?    ?   ?
?  ?  ?          [QR CODE IMAGE]                   ?    ?   ?
?  ?  ?                                            ?    ?   ?
?  ?  ??????????????????????????????????????????????    ?   ?
?  ?                                                      ?   ?
?  ?  Wallet Address:                                    ?   ?
?  ?  TXYZa1b2c3d4e5f6g7h8... [?? Copy]                 ?   ?
?  ?                                                      ?   ?
?  ?  Transaction Hash:                                  ?   ?
?  ?  [___________________________________]              ?   ?
?  ?  [Submit Payment]                                   ?   ?
?  ?                                                      ?   ?
?  ?  Instructions:                                      ?   ?
?  ?  1. Scan QR code or copy address                   ?   ?
?  ?  2. Send exactly 10.023456 USDT                    ?   ?
?  ?  3. Copy transaction hash                          ?   ?
?  ?  4. Paste and submit                               ?   ?
?  ????????????????????????????????????????????????????????   ?
???????????????????????????????????????????????????????????????
                           ?
             After TX hash submission
                           ?
???????????????????????????????????????????????????????????????
?                 Payment Status Screen                        ?
?  ????????????????????????????????????????????????????????   ?
?  ?  Status: Confirming ?                               ?   ?
?  ?                                                      ?   ?
?  ?  Confirmations: 12/19                               ?   ?
?  ?  ????????????????????                               ?   ?
?  ?                                                      ?   ?
?  ?  Estimated time: ~30 seconds                        ?   ?
?  ?                                                      ?   ?
?  ?  Transaction Hash:                                  ?   ?
?  ?  0xabc123... [View on Explorer]                     ?   ?
?  ????????????????????????????????????????????????????????   ?
???????????????????????????????????????????????????????????????
                           ?
              All confirmations received
                           ?
???????????????????????????????????????????????????????????????
?                    Success Screen                            ?
?  ????????????????????????????????????????????????????????   ?
?  ?              ?                                       ?   ?
?  ?       Payment Successful!                            ?   ?
?  ?                                                      ?   ?
?  ?  Your premium subscription is now active.           ?   ?
?  ?                                                      ?   ?
?  ?  Transaction: 0xabc123...                           ?   ?
?  ?  Date: Jan 15, 2024 10:45 AM                        ?   ?
?  ?                                                      ?   ?
?  ?  [Done] [View History]                              ?   ?
?  ????????????????????????????????????????????????????????   ?
???????????????????????????????????????????????????????????????
```

---

**Last Updated**: January 2024  
**Version**: 1.0  
**Backend**: .NET 10 / ASP.NET Core  
**Frontend**: Expo React Native
